name: Build

on:
  push:
    branches:
      - master
    tags:
      - '*'

jobs:
  build-base:
    name: Base OS
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build images
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: anyfiddle/base
        path: ./_base_images/base
        tags: latest

  build:
    name: Base
    needs: build-base
    runs-on: ubuntu-latest
    strategy:
      matrix:
        template: [
          'base-deno',
          'base-elixir',
          'base-golang',
          'base-java',
          'base-nodejs',
          'base-python',
          'base-python3'
        ]
    steps:
    - uses: actions/checkout@v2
    - name: Build images
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: anyfiddle/${{ matrix.template }}
        path: ./_base_images/${{ matrix.template }}
        tags: latest
  
  build-starter-template-images:
    name: Templates
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        template: [
          'deno',
          'elixir',
          'golang',
          'html-css-js',
          'java',
          'nodejs',
          'nodejs-express',
          'python',
          'python3',
          'reactjs',
          'ubuntu'
        ]
    steps:
    - uses: actions/checkout@v2
    
    - name: Build images
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: anyfiddle/${{ matrix.template }}
        path: ./${{ matrix.template }}
        tags: dev
        tag_with_ref: true
   
    - name: Setup google cloud for gcs
      uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_email: ${{ secrets.GCP_SA_EMAIL }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
  
    - name: Upload thumbnail
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        src="${{ matrix.template }}/thumbnail.png"
        dest="gs://anyfiddle-com-templates-thumbnails/${{ matrix.template }}.png"
        gsutil cp "$src" "${dest}"

    - name: Webhook to update image in templates
      if: startsWith(github.ref, 'refs/tags/')
      shell: bash
      env:
        HOOK_SECRET: ${{ secrets.HOOK_SECRET }}
      run: |
        version="${GITHUB_REF/refs\/tags\//}"
        image=anyfiddle/${{ matrix.template }}:$version
        thumbnail="https://storage.googleapis.com/anyfiddle-com-templates-thumbnails/${{ matrix.template }}.png?v=$version"
        jsonToPost=`jq -Sc ".image = "\""$image"\"" | .thumbnail="\""$thumbnail"\""" ${{ matrix.template }}/template.json`

        hookUrl="https://www.anyfiddle.com/api/hooks/template-update/${{ matrix.template }}"

        signature=`echo -n "$jsonToPost" | openssl dgst -sha1 -hmac "$HOOK_SECRET" | sed 's/^.* //'`
        curl --location --request POST "${hookUrl}" \
          --header "x-hook-signature: $signature" \
          --header 'Content-Type: application/json' \
          --data-raw "$jsonToPost"
